{% load static %}
<!doctype html>

<html lang="en" class="layout-menu-fixed layout-compact" data-assets-path="{% static '' %}" data-template="vertical-menu-template-free">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>Citas Médicas | Admin</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon/favicon.ico' %}" />

    <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="{% static 'vendor/css/core.css' %}" />
  <link rel="stylesheet" href="{% static 'css/core.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}" />

  <!-- Page CSS -->
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />

  <!-- Helpers -->
  <script src="{% static 'vendor/js/helpers.js' %}"></script>
  <script src="{% static 'js/config.js' %}"></script>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->

            <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo">
          <a href="principal.html" class="app-brand-link">
            <span class="app-brand-logo demo">
              <span class="text-primary">
                <!-- Logo SVG simplificado o removido si no es necesario -->
                <svg width="25" viewBox="0 0 25 42" xmlns="http://www.w3.org/2000/svg"></svg>
              </span>
            </span>
            <span class="app-brand-text demo menu-text fw-bold ms-2">Salud total</span>
          </a>
          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
            <i class="bx bx-chevron-left d-block d-xl-none align-middle"></i>
          </a>
        </div>

        <ul class="menu-inner py-1">
          <li class="menu-item active open">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-home-smile"></i>
              <div class="text-truncate">Menu</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="calificar" class="menu-link">
                  <div class="text-truncate">Calificar cita</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="habilitar" class="menu-link">
                  <div class="text-truncate">Habilitar hora</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="detalle" class="menu-link">
                  <div class="text-truncate">Detalle de citas</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="historial" class="menu-link">
                  <div class="text-truncate">Historial de citas</div>
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </aside>
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">
                <!-- Content wrapper -->
                <div class="content-wrapper">
                    <!-- Content -->
                    <div class="container-xxl flex-grow-1 container-p-y">

                        <!-- Navegación -->
                        <nav class="navbar navbar-expand-lg mb-12">
                            <div class="container-fluid">
                                <a class="navbar-brand" href="javascript:void(0)">Mis Citas</a>
                                <form class="d-flex" onsubmit="return false">
                                    <input class="form-control me-2 bg-white" type="search"
                                        placeholder="Buscar por ID de cita..." aria-label="Buscar" />

                                    <button class="btn btn-primary" type="button" type="button" data-bs-toggle="modal"
                                        data-bs-target="#modalCita">Crear</button>
                                </form>
                            </div>
                        </nav>
                        <!-- Fin Navegación -->

                        <!-- Modal -->
                        <div class="modal fade" id="modalCita" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <form>
                                        <div class="modal-header">
                                            <h5 class="modal-title">Crear cita</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>

                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col mb-6">
                                                    <label for="nombre" class="form-label">Nombre completo</label>
                                                    <input type="text" id="nombre" class="form-control"
                                                        placeholder="Ingresar Nombre completo..." />
                                                </div>
                                                <div class="col mb-6">
                                                    <label for="rut" class="form-label">RUT</label>
                                                    <input type="text" id="rut" class="form-control"
                                                        placeholder="Ingresar RUT..." />
                                                </div>
                                            </div>

                                            <div class="row g-6">
                                                <div class="col mb-6">
                                                    <label for="edad" class="form-label">Edad</label>
                                                    <input type="number" id="edad" class="form-control"
                                                        placeholder="Ingresar tu edad..." />
                                                </div>
                                                <div class="col mb-0">
                                                    <label for="genero" class="form-label">Género</label>
                                                    <select class="form-select" id="genero"
                                                        aria-label="Default select example">
                                                        <option selected>Seleccionar...</option>
                                                        <option value="1">Masculino</option>
                                                        <option value="2">femenino</option>
                                                        <option value="3">Otro</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row g-6">
                                                <div class="col mb-6">
                                                    <label for="email" class="form-label">Correo electrónico</label>
                                                    <input type="email" id="email" class="form-control"
                                                        placeholder="mi-correo@mail.com" />
                                                </div>
                                            </div>

                                            <div class="row g-6">
                                                <div class="col mb-6">
                                                    <label for="fecha" class="col-md-6 col-form-label">Fecha</label>
                                                    <div class="col-md-12">
                                                        <input class="form-control" type="date" value="2025-05-25"
                                                            id="fecha" />
                                                    </div>
                                                </div>

                                                <div class="col mb-6">
                                                    <label for="horaCita" class="col-md-6 col-form-label">Hora
                                                        de
                                                        cita</label>
                                                    <div class="col-md-12">
                                                        <input class="form-control" type="time" value="12:30:00"
                                                            id="horaCita" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-label-secondary"
                                                data-bs-dismiss="modal">
                                                Cancelar
                                            </button>
                                            <button type="button" class="btn btn-primary">Guardar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de citas -->
                        <div class="card">
                            <h5 class="card-header">Citas Médicas</h5>
                            <div class="table-responsive text-nowrap">
                                <table class="table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Fecha de cita</th>
                                            <th>Motivo</th>
                                            <th>Especialidad</th>
                                            <th>Médico</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-border-bottom-0">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Fin Tabla de citas -->

                        <!-- / Content -->
                        <div class="content-backdrop fade"></div>
                    </div>
                    <!-- Content wrapper -->
                </div>
                <!-- / Layout page -->
            </div>

            <!-- Overlay -->
            <div class="layout-overlay layout-menu-toggle"></div>
        </div>
        <!-- / Layout wrapper -->
        <!-- Core JS -->

        <script src="../assets/vendor/libs/jquery/jquery.js"></script>
        <script src="../assets/vendor/libs/popper/popper.js"></script>
        <script src="../assets/vendor/js/bootstrap.js"></script>
        <script src="../assets/vendor/js/menu.js"></script>

        <!-- endbuild -->

        <!-- Vendors JS -->

        <!-- Main JS -->

        <script src="../assets/js/main.js"></script>

        <!-- Page JS -->

        <!-- Place this tag before closing body tag for github widget button. -->
        <script async defer src="https://buttons.github.io/buttons.js"></script>


        <script>
            let modo = 'crear';
            let filaEditando = null;
            let idCita = 0;
            let nombre = document.getElementById('nombre');
            let rut = document.getElementById('rut');
            let edad = document.getElementById('edad');
            let genero = document.getElementById('genero');
            let email = document.getElementById('email');
            let fecha = document.getElementById('fecha');
            let hora = document.getElementById('horaCita');
            let btnGuardar = document.querySelector('.modal .btn.btn-primary');
            let btnCancelar = document.querySelector('.btn.btn-label-secondary');
            let tabla = document.querySelector('.table tbody');

            btnGuardar.addEventListener('click', function () {
                if (!nombre.value || !rut.value || !edad.value || !email.value || !fecha.value || !hora.value || genero.value === "Seleccionar...") {
                    alert("Por favor completa todos los campos.");
                    return;
                }

                if (modo === 'crear') {
                    let fila = document.createElement('tr');
                    fila.innerHTML = `
                  <td><span>${idCita}</span></td>
                  <td>${formatearFecha(fecha.value)} ${hora.value}</td>
                  <td>No especificado</td>
                  <td>General</td>
                  <td class="datos-paciente"
                      data-nombre="${nombre.value}"
                      data-rut="${rut.value}"
                      data-edad="${edad.value}"
                      data-genero="${genero.value}"
                      data-email="${email.value}">
                    ${'No asignado'}<br>
                  </td>
                  <td>Pendiente</td>
                  <td>
                    <button class="btn-modificar btn btn-outline-warning">Modificar</button>
                    <button class="btn-cancelar btn btn-outline-danger">Cancelar</button>
                  </td>
                `;

                    // Esta data es la se envia desde el formulario hacia la API
                    const apiData = {
                        id: idCita,
                        fecha: formatearFecha(fecha.value),
                        hora: hora.value,
                        motivo: "No especificado",
                        especialidad: "General",
                        nombre: nombre.value,
                        rut: rut.value,
                        edad: edad.value,
                        genero: genero.value,
                        email: email.value,
                        estado: "Pendiente"
                    }

                    tabla.appendChild(fila);
                    idCita++;
                    alert("Cita creada con éxito");
                }


                if (modo === 'modificar' && filaEditando !== null) {
                    const confirmarCita = confirm("¿Estás seguro de que deseas actualizar la hora de la cita?");

                    if (!confirmarCita) {
                        alert("No se realizaron cambios.");
                        cerrarModal();
                        return;
                    }

                    let celdaFecha = filaEditando.cells[1];
                    let fechaTexto = formatearFecha(fecha.value);
                    celdaFecha.textContent = fechaTexto + " " + hora.value;

                    alert("Hora de cita actualizada");
                }

                resetearFormulario();
                cerrarModal();
            });

            tabla.addEventListener('click', function (e) {
                if (e.target.classList.contains('btn-modificar')) {
                    let fila = e.target.closest('tr');
                    let fechaHora = fila.cells[1].textContent.split(" ");
                    let soloFecha = fechaHora[0];
                    let soloHora = fechaHora[1];
                    let celdaPaciente = fila.querySelector('.datos-paciente');

                    nombre.value = celdaPaciente.getAttribute('data-nombre');
                    rut.value = celdaPaciente.getAttribute('data-rut');
                    edad.value = celdaPaciente.getAttribute('data-edad');
                    genero.value = celdaPaciente.getAttribute('data-genero');
                    email.value = celdaPaciente.getAttribute('data-email');
                    fecha.value = invertirFecha(soloFecha);
                    hora.value = soloHora;
                    nombre.disabled = true;
                    rut.disabled = true;
                    edad.disabled = true;
                    genero.disabled = true;
                    email.disabled = true;
                    fecha.disabled = true;
                    hora.disabled = false;
                    modo = 'modificar';
                    filaEditando = fila;

                    abrirModal();
                }

                if (e.target.classList.contains('btn-cancelar')) {
                    let confirmar = confirm("¿Seguro que quieres cancelar esta cita?");
                    if (confirmar) {
                        e.target.closest('tr').remove();
                        alert("Cita eliminada");
                    }
                }
            });

            btnCancelar.addEventListener('click', function () {
                resetearFormulario();
            });

            function resetearFormulario() {
                nombre.disabled = false;
                rut.disabled = false;
                edad.disabled = false;
                genero.disabled = false;
                email.disabled = false;
                fecha.disabled = false;
                hora.disabled = false;
                nombre.value = "";
                rut.value = "";
                edad.value = "";
                genero.value = "Seleccionar...";
                email.value = "";
                fecha.value = "";
                hora.value = "";
                modo = 'crear';
                filaEditando = null;
            }

            function formatearFecha(f) {
                let partes = f.split("-");
                return partes[2] + "-" + partes[1] + "-" + partes[0];
            }

            function invertirFecha(f) {
                let partes = f.split("-");
                return partes[2] + "-" + partes[1] + "-" + partes[0];
            }

            function cerrarModal() {
                let modal = bootstrap.Modal.getInstance(document.getElementById('modalCita'));
                modal.hide();
            }

            function abrirModal() {
                let modal = new bootstrap.Modal(document.getElementById('modalCita'));
                modal.show();
            }

            let buscador = document.querySelector('.navbar input[type="search"]');
            buscador.addEventListener('input', function () {
                let texto = this.value.trim();
                let filas = tabla.querySelectorAll('tr');

                filas.forEach(fila => {
                    let id = fila.querySelector('td span').textContent;
                    if (texto === "" || id.includes(texto)) {
                        fila.style.display = "";
                    } else {
                        fila.style.display = "none";
                    }
                });
            });
        </script>
</body>

</html>